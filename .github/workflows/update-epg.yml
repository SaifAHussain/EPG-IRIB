name: Update EPG

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run tests
        run: uv run pytest tests/ -v

      - name: Generate EPG (attempt 1)
        id: attempt1
        continue-on-error: true
        env:
          SEPEHR_CONSUMER_KEY: ${{ secrets.SEPEHR_CONSUMER_KEY }}
          SEPEHR_CONSUMER_SECRET: ${{ secrets.SEPEHR_CONSUMER_SECRET }}
          SEPEHR_ACCESS_TOKEN: ${{ secrets.SEPEHR_ACCESS_TOKEN }}
          SEPEHR_TOKEN_SECRET: ${{ secrets.SEPEHR_TOKEN_SECRET }}
        run: uv run generate_epg.py

      - name: Wait before retry
        if: steps.attempt1.outcome == 'failure'
        run: sleep 30

      - name: Generate EPG (attempt 2)
        id: attempt2
        if: steps.attempt1.outcome == 'failure'
        continue-on-error: true
        env:
          SEPEHR_CONSUMER_KEY: ${{ secrets.SEPEHR_CONSUMER_KEY }}
          SEPEHR_CONSUMER_SECRET: ${{ secrets.SEPEHR_CONSUMER_SECRET }}
          SEPEHR_ACCESS_TOKEN: ${{ secrets.SEPEHR_ACCESS_TOKEN }}
          SEPEHR_TOKEN_SECRET: ${{ secrets.SEPEHR_TOKEN_SECRET }}
        run: uv run generate_epg.py

      - name: Wait before final retry
        if: steps.attempt1.outcome == 'failure' && steps.attempt2.outcome == 'failure'
        run: sleep 60

      - name: Generate EPG (attempt 3)
        id: attempt3
        if: steps.attempt1.outcome == 'failure' && steps.attempt2.outcome == 'failure'
        env:
          SEPEHR_CONSUMER_KEY: ${{ secrets.SEPEHR_CONSUMER_KEY }}
          SEPEHR_CONSUMER_SECRET: ${{ secrets.SEPEHR_CONSUMER_SECRET }}
          SEPEHR_ACCESS_TOKEN: ${{ secrets.SEPEHR_ACCESS_TOKEN }}
          SEPEHR_TOKEN_SECRET: ${{ secrets.SEPEHR_TOKEN_SECRET }}
        run: uv run generate_epg.py

      - name: Validate EPG XML
        if: steps.attempt1.outcome == 'success' || steps.attempt2.outcome == 'success' || steps.attempt3.outcome == 'success'
        run: |
          echo "Validating epg.xml..."

          # Check file exists and is non-empty
          if [ ! -s epg.xml ]; then
            echo "‚ùå epg.xml is missing or empty"
            exit 1
          fi

          # Check it's valid XML
          python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('epg.xml')
          root = tree.getroot()
          progs = root.findall('programme')
          chans = root.findall('channel')
          print(f'‚úÖ Valid XML: {len(progs)} programmes, {len(chans)} channels')
          if len(progs) < 10:
              print(f'‚ùå Only {len(progs)} programmes ‚Äî too few')
              exit(1)
          "

      - name: Commit and push
        if: steps.attempt1.outcome == 'success' || steps.attempt2.outcome == 'success' || steps.attempt3.outcome == 'success'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add epg.xml
          git diff --staged --quiet || git commit -m "Update EPG $(date -u +%Y-%m-%d)"
          git push

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® EPG Generator Failed';
            const body = `The EPG generator failed after 3 attempts. Both data sources must have returned no data.

            **Possible causes:**

            **Sepehr TV API**
            - OAuth keys may have been rotated
            - Fix: Go to [sepehrtv.ir](https://sepehrtv.ir) ‚Üí DevTools ‚Üí Sources ‚Üí search JS for \`consumer\` or \`getAuthHeaderForRequest\`
            - Extract the updated consumer key/secret and token key/secret
            - Update the four GitHub Secrets: \`SEPEHR_CONSUMER_KEY\`, \`SEPEHR_CONSUMER_SECRET\`, \`SEPEHR_ACCESS_TOKEN\`, \`SEPEHR_TOKEN_SECRET\`

            **Radio Quran (radioquran.ir)**
            - The site may be down or its HTML structure may have changed
            - Check if [radioquran.ir/ChannelConductor/](https://radioquran.ir/ChannelConductor/) loads in a browser
            - If the page structure changed, \`parse_radio_quran_html()\` in \`generate_epg.py\` may need updating

            Re-run this workflow after fixing: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'epg-failed'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['epg-failed']
              });
            }
